version: '1.0'

steps:
  
  ValidateCharts:
    title: Validate Helm Charts with Helm lint
    image: 'codefresh/plugin-helm:2.8.2'
    commands:
      - helm init --client-only
      - cd helm
      - ./update-deps.sh
      - helm lint frcommon
      - helm lint amster
      - helm lint openam
      - helm lint opendj
  
  #ValidateKubernetesTemplates:
  #  title: Validate Kubernetes templates with kubeval
  #  image: 'codefresh/plugin-helm:2.8.2'
  #  commands:
  #    - wget https://github.com/garethr/kubeval/releases/download/0.6.0/kubeval-darwin-amd64.tar.gz
  #    - tar xf kubeval-darwin-amd64.tar.gz
  #    - cp kubeval /usr/local/bin
  #    - echo $PATH
  #    - helm init --client-only
  #    - kubectl version --client
  #    - kubeval --version
      #- helm template helm/amster | kubeval
      #- helm template helm/openam | kubeval
      #- helm template helm/opendj | kubeval
  
  KubernetesDeploymentAmster:
    title: Helm Upgrade Amster
    image: 'codefresh/plugin-helm:2.8.2'
    environment:
      - CHART_NAME=${{CHART_NAME_amster}}
      - RELEASE_NAME_amster=${{RELEASE_NAME_amster}}
      - KUBE_CONTEXT=${{KUBE_CONTEXT}}
      - NAMESPACE=${{NAMESPACE}}
      #- CHART_REPO_URL=https://storage.googleapis.com/forgerock-charts/
      - CUSTOMFILE_amster=${{CUSTOMFILE_amster}}
    commands:
      - cf_export KUBE_CONTEXT
      - kubectl config use-context ${KUBE_CONTEXT}
      - helm init --client-only
      - helm upgrade -i ${RELEASE_NAME_amster} ${CHART_NAME} --namespace ${NAMESPACE} --values ${CUSTOMFILE_amster}
    fail_fast: false

  KubernetesDeploymentAM:
    title: Helm Upgrade AM
    image: 'codefresh/plugin-helm:2.8.2'
    environment:
      - CHART_NAME=${{CHART_NAME_openam}}
      - RELEASE_NAME_openam=${{RELEASE_NAME_openam}}
      - KUBE_CONTEXT=${{KUBE_CONTEXT}}
      - NAMESPACE=${{NAMESPACE}}
      #- CHART_REPO_URL=https://storage.googleapis.com/forgerock-charts/
      - CUSTOMFILE_am=${{CUSTOMFILE_openam}}
    commands:
      - cf_export KUBE_CONTEXT
      - kubectl config use-context ${KUBE_CONTEXT}
      - helm init --client-only
      - cd helm
      - ./update-deps.sh
      - cd ../
      - helm upgrade -i ${RELEASE_NAME_openam} ${CHART_NAME} --namespace ${NAMESPACE} --values ${CUSTOMFILE_am}
    fail_fast: false
    
  KubernetesDeploymentDSConfig:
    title: Helm Upgrade DS Config
    image: 'codefresh/plugin-helm:2.8.2'
    environment:
      - CHART_NAME=${{CHART_NAME_ds}}
      - RELEASE_NAME_dsconfig=${{RELEASE_NAME_dsconfig}}
      - KUBE_CONTEXT=${{KUBE_CONTEXT}}
      - NAMESPACE=${{NAMESPACE}}
      #- CHART_REPO_URL=https://storage.googleapis.com/forgerock-charts/
      - CUSTOMFILE_dsconfig=${{CUSTOMFILE_dsconfig}}
    commands:
      - cf_export KUBE_CONTEXT
      - kubectl config use-context ${KUBE_CONTEXT}
      - helm init --client-only
      - cd helm
      - ./update-deps.sh
      - cd ../
      - helm upgrade -i ${RELEASE_NAME_dsconfig} ${CHART_NAME} --namespace ${NAMESPACE} --values ${CUSTOMFILE_dsconfig}
    fail_fast: false  
    
  KubernetesDeploymentDSCTS:
    title: Helm Upgrade DS CTS
    image: 'codefresh/plugin-helm:2.8.2'
    environment:
      - CHART_NAME=${{CHART_NAME_ds}}
      - RELEASE_NAME_dscts=${{RELEASE_NAME_dscts}}
      - KUBE_CONTEXT=${{KUBE_CONTEXT}}
      - NAMESPACE=${{NAMESPACE}}
      #- CHART_REPO_URL=https://storage.googleapis.com/forgerock-charts/
      - CUSTOMFILE_dscts=${{CUSTOMFILE_dscts}}
    commands:
      - cf_export KUBE_CONTEXT
      - kubectl config use-context ${KUBE_CONTEXT}
      - helm init --client-only
      - cd helm
      - ./update-deps.sh
      - cd ../
      - helm upgrade -i ${RELEASE_NAME_dscts} ${CHART_NAME} --namespace ${NAMESPACE} --values ${CUSTOMFILE_dscts}
    fail_fast: false  
  
  #Helm_Upgrade_Amster:
  #  title: Helm Upgrade Amster
  #  image: 'codefresh/plugin-helm:2.8.2'
  #  environment:
  #    - CHART_NAME=${{CHARTNAME_amster}}
  #    - RELEASE_NAME=amster
  ##    - KUBE_CONTEXT=eng-shared@EngineeringDevOps
  #    - NAMESPACE=lee
  #    - CHART_REPO_URL=https://storage.googleapis.com/forgerock-charts/
  #    - CUSTOMFILE_amster='codefresh/amster_values.yaml'
      
  #Helm_Upgrade_OpenAM:
  #  title: Helm Upgrade OpenAM
  #  image: 'codefresh/plugin-helm:2.8.2'
  #  environment:
  ##    - CHART_NAME_openam=$
  #    - RELEASE_NAME=$
  #    - KUBE_CONTEXT=$
  #    - NAMESPACE=$
  #    - DEBUG_CHART=$
  ##    - CHART_REPO_URL=$
  #    - CUSTOMFILE_openam=$
      
  #Helm_Upgrade_OpenDJ_Config:
  #  title: Helm Upgrade OpenDJ - Config
  #  image: 'codefresh/plugin-helm:2.8.2'
  #  environment:
  #    - CHART_NAME_opendj=$
  #    - RELEASE_NAME=$
  #    - KUBE_CONTEXT=$
  #    - NAMESPACE=$
  #    - DEBUG_CHART=$
  #    - CHART_REPO_URL=$
  #    - CUSTOMFILE_opendj_config=$

  #Helm_Upgrade_OpenDJ_CTS:
  # title: Helm Upgrade OpenDJ - CTS
  #  image: 'codefresh/plugin-helm:2.8.2'
  #  environment:
  #    - CHART_NAME_opendj=$
  #    - RELEASE_NAME=$
  #    - KUBE_CONTEXT=$
  #    - NAMESPACE=$
  #    - DEBUG_CHART=$
  #    - CHART_REPO_URL=$
  #    - CUSTOMFILE_opendj_cts=$
    